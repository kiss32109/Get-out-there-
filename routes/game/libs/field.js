const UTILITY = require('./utility.js');
const ITEM = require('./inventory.js');

/* 필드 클래스 정의 */
Field = function(parent){

    /* 맵 목록과 오브젝트 목록을 속성으로 갖는 필드 객체 */
    var self = {
      parent: parent,
      map: {},
    }

    /* 필드에 디폴트맵 추가 작업 */
    self.setDefaultMap = function(){
      let default_map = Maps.list['main_field'];
      /* 이미 목록에 있는 경우 */
		  for(var i in self.map){
      	if(self.map[i].id === default_map['id']){
      		self.map = [];
      	}
    	}
      self.map = default_map;
    }
    self.isOutOfField = function(gridX, gridY) {
      if(gridX<0 || gridX>=field.ground.pattern.length-1) { return true; };
      if(gridY<0 || gridY>=field.ground.pattern[0].length-1) { return true; };
      return false;
    }

    self.getSpecificTile = function(location, field) {
      /* 필드의 크기와 대상 객체의 좌표값을 이용해 각각의 타일 좌표 구하기 */
      var gridX = Math.floor((field.width/2+location.x)/(field.width/30));
      var gridY = Math.floor((field.height/2+location.y)/(field.height/30));
      return [gridX, gridY];
    }

    self.getFrontTile = function(location, field) {
      /* 필드의 크기와 대상 객체의 좌표값을 이용해 각각의 타일 좌표 구하기 */
      var gridX = Math.floor((field.width/2+location.x)/(field.width/30));
      var gridY = Math.floor((field.height/2+location.y)/(field.height/30));
      if(location.direction === 0 && !self.isOutOfField(gridX,gridY+1)) return field.deco.pattern[gridY+1][gridX];
      if(location.direction === 1 && !self.isOutOfField(gridX,gridY-1)) return field.deco.pattern[gridY-1][gridX];
      if(location.direction === 2 && !self.isOutOfField(gridX+1,gridY)) return field.deco.pattern[gridY][gridX+1];
      if(location.direction === 3 && !self.isOutOfField(gridX-1,gridY)) return field.deco.pattern[gridY][gridX-1];
      return;
    }

    self.collision = function(location, field) {
      /* 필드의 크기와 대상 객체의 좌표값을 이용해 각각의 타일 좌표 구하기 */
      var gridX = Math.floor((field.width/2+location.x)/(field.width/30));
      var gridY = Math.floor((field.height/2+location.y)/(field.height/30));

      /* 타일 좌표값 X,Y가 설정된 필드의 범위를 벗어나는 경우 */
      if(self.isOutOfField(gridX,gridY)) { return 'ENTITY'; };

      function contains(target, pattern){
        var value = 0;
        pattern.forEach(function(word){
          value = value + (target===word);
        });
        return (value === 1)
      }
      var exceptionArr = [
                        '0-57','0-88','0-41',
                        '1-214', '1-215', '1-216', '1-230', '1-231', '1-232', '1-246', '1-247', '1-248', '1-225'
                      ];
      if(!contains(field.ground.pattern[gridY][gridX], exceptionArr)) { return 'ENTITY' }

      /* 타일 좌표값 기준, 오버랩된 데코레이션 충돌 감지 */
      if(field.deco.pattern[gridY][gridX].constructor === Object) { return 'PLAYER'; }
      if(field.deco.pattern[gridY][gridX].constructor === String) {
        if(field.deco.pattern[gridY][gridX].includes('4-')) { return 'PLAYER'; }
        if(field.deco.pattern[gridY][gridX].includes('7-')) { return 'PLAYER'; }
       }
      return field.ground.pattern[gridY][gridX];
    }

	return self;
}

/* 오브젝트 클래스 정의 */
Objects = function(id, name, deco_number, event, hp, hpMAX, droppable){
  var self = {
  	id: id,
  	name: name,
    deco_number: deco_number,
    event: event,
    /* 필드 객체 정의 */
    hp: hp,
    hpMAX: hpMAX,
    droppable: droppable,
  }
  Objects.list[self.id] = self;
  return self;
}
Objects.createObjectHasDiedItems = function(player) {
  /* 플레이어가 죽은 타일 인덱스값 구하기 */
  var diedGridXY = player.field.getSpecificTile(player.location, player.field.map.field);
  console.log(player.field.map.field.deco.pattern[diedGridXY[1]][diedGridXY[0]]);
  /* 필드 데코레이션 해당 타일값에 새로 생성한 오브젝트 배치하기 */
  player.field.map.field.deco.pattern[diedGridXY[1]][diedGridXY[0]] = new Objects(
    UTILITY.getGUID(),
    player.id + "'s ITEMS",
    '6-17',
    function(){},
    10,
    10,
    player.inventory.items,
  );
  console.log(diedGridXY);
  console.log(player.field.map.field.deco.pattern[diedGridXY[1]][diedGridXY[0]]);
  /* 사용자들에게 오브젝트 변경사항 전달하기 */
  for(var i in SOCKET_LIST){
    SOCKET_LIST[i].emit('mapChanged', player.field.map.field.deco);
  }
}
Objects.createObjectHasRandomItems = function(id) {
  switch (id) {
    case 'supply_box':
      return new Objects(
        UTILITY.getGUID(),
        'SUPPLY BOX',
        '6-17',
        function(){},
        10,
        10,
        setRandomDroppableItem(),
      );
    default:
      break;
  }
}
Objects.interaction = function(socket) {

  socket.on('updateObjects', function(data) {
    /* 데이터로 넘어온 오브젝트 ID와 선택된 ITEM ID를 통해
       해당 오브젝트 객체를 찾고 목록에서 제거 */
    for(var index in Objects.list) {
      if(data.id === Objects.list[index].id) {
        delete Objects.list[index].droppable[data.item];
        if(Object.keys(Objects.list[index].droppable).length===0) {
          delete Objects.list[index];
          for(var indexMAP in Maps.list) {
            for(var indexY=0; indexY<Maps.list[indexMAP].field.deco.pattern.length; indexY++) {
              for(var indexX=0; indexX<Maps.list[indexMAP].field.deco.pattern[indexY].length; indexX++) {
                if(Maps.list[indexMAP].field.deco.pattern[indexY][indexX].constructor===String){ continue; }
                if(Maps.list[indexMAP].field.deco.pattern[indexY][indexX].constructor===Object) {
                  if(Maps.list[indexMAP].field.deco.pattern[indexY][indexX].id === data.id) {
                    Maps.list[indexMAP].field.deco.pattern[indexY][indexX] = '';
                    for(var i in SOCKET_LIST){
                      SOCKET_LIST[i].emit('mapChanged', Maps.list[indexMAP].field.deco);
                    }
                  }
                }
              }
            }
          }
        }
        for(var i in SOCKET_LIST){
          SOCKET_LIST[i].emit('ObjectChanged', Objects.list[index]);
        }
      }
    }
  });
}
Objects.list = {};
/* /맵 클래스 정의 */

var setRandomDroppableItem = function() {
  var droppableItems = ['healing_potion_small', 'mana_potion_small','energy_potion_small','invisible_potion_small',
                        'healing_potion_medium', 'mana_potion_medium', 'energy_potion_medium',
                        'chest_leather_vest_yellow_cloth', 'head_farmer_hat_straw_cloth', 'legs_leather_white_cloth'
                      ];
  var tmpDroppable = {};
  var count = UTILITY.randomRange(1,5);
  var index = 0;
  while(index<count) {
    var key = droppableItems[UTILITY.randomRange(0,9)];
    if(tmpDroppable[key]===undefined) {
      tmpDroppable[key] = UTILITY.clone(Item.list[key]);
      tmpDroppable[key].amount++;
    }
    else {
      tmpDroppable[key].amount++;
    }
    index++;
  }
  return tmpDroppable;
}

/* 맵 클래스 정의 */
Maps = function(id, name, event, field){
	var self = {
		id: id,
		name: name,
    event: event,
    /* 필드 객체 정의 */
    field: field,
	}
	Maps.list[self.id] = self;
	return self;
}
Maps.list = {};
/* /맵 클래스 정의 */

Maps.supplyRespon = function() {
  Maps.list['main_field'].field.deco.pattern = setPatternWithObjects();
  return Maps.list['main_field'].field.deco;
}

var setPatternWithObjects = function() {
  var basePattern = [
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','0-218','0-219','0-220','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','0-234','0-235','0-236','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','0-116','0-88','0-250','0-251','0-252','0-88','0-100','','','','','','','','','','','','','','','','','','','',''],
    ['','','','0-116','0-88','0-88','0-88','0-88','0-88','0-100','','','','','','','','','','','','','','','','','','','',''],
    ['','','','0-116','0-88','0-88','0-88','0-88','0-88','0-100','','','','','','','','','','','','','','','','','','','',''],
    ['','','','0-118','0-101','0-101','0-101','0-101','0-101','0-119','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','1-214','1-215','1-215','1-215','1-216','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','1-230','1-231','1-231','1-231','1-232','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','1-230','1-231','1-231','1-231','1-232','','','','0-131','0-132','0-194','0-195','0-226','0-227','','0-133','0-192','0-193','','','','','','','',''],
    ['','','','','1-230','1-231','1-231','1-231','1-232','','','','0-147','0-148','0-244','0-245','0-240','0-241','','0-149','0-240','0-241','','','','','','','',''],
    ['','','','','1-246','1-247','1-247','1-247','1-248','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','1-144','1-145','1-146','1-147','1-148','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','1-149','1-150','1-151','1-152','','','','','','','','','','','','','','','','','','','','',''],

    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],  //16, 20
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','1-214','1-215','1-215','1-215','1-216','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','1-230','1-231','1-231','1-231','1-232','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','1-230','1-231','1-231','1-231','1-232','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','1-230','1-231','1-231','1-231','1-232','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','1-246','1-247','1-247','1-247','1-248','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','1-144','1-145','1-146','1-147','1-148','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','1-149','1-150','1-151','1-152',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','','0-17','0-17','','','','','','','','','','','','','','','','','','','','','',''],
  ];
  for (var Y = 0; Y < basePattern.length; Y++) {
    if(Y===0) continue;
    for (var X = 0; X < basePattern[Y].length; X++) {
      if(X===0) continue;
      if(basePattern[Y][X]==='1-231') {
        if(Math.random()<0.5){
          basePattern[Y][X] = Objects.createObjectHasRandomItems('supply_box');
        }
      }
    }
  }
  return basePattern;
}

Maps(
  "main_field",
  "Main Field",
  function(player){},
  field = {

    columns:30,
    height:1440,
    width:1440,

    ground: {

      pattern: [
        ['0-0','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-2','0-0','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-2'],
        ['0-16','0-13','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-18','0-16','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-15','0-18'],
        ['0-16','0-29','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-18','0-16','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-31','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18','0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18','0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18','0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18','0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18','0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18','0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18','0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-57','0-57','0-18','0-32','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-4','0-57','0-57','0-3','0-33','0-33','0-33','0-34'],
        ['0-16','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-57','0-57','0-19','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-1','0-20','0-57','0-57','0-19','0-1','0-1','0-1','0-2'],
        ['0-16','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-57','0-57','0-13','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-14','0-15','0-57','0-57','0-13','0-14','0-14','0-15','0-18'],
        ['0-16','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-57','0-57','0-29','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-30','0-31','0-57','0-57','0-29','0-30','0-30','0-31','0-18'],
        ['0-16','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','1-225','1-225','1-225','1-225','1-225','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-16','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-57','0-18'],
        ['0-32','0-33','0-33','0-33','0-33','0-4','0-57','0-57','0-3','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-33','0-34']

              ],
      tiles: {
          imgs: [
                'deco_inside_house',
                'deco_inside_house_2',
                'ground_grounds_1',
                'ground_grounds_2',
                'ground_paths_cobble_1',
                'ground_paths_grass_1',
                'ground_water',
                'ground_cliffs'],
          columns: 16,
          height: 16,
          width: 16,
      },
    },

    deco: {
      pattern: setPatternWithObjects(),
      tiles: {
          imgs: [
                'deco_inside_house',
                'deco_inside_house_2',
                'ground_grounds_1',
                'ground_grounds_2',
                'ground_paths_cobble_1',
                'ground_paths_grass_1',
                'collectible_idle_body_boxes',
                'ground_water',
                'ground_cliffs',
                'deco_ruins',
                '',
              ],
          columns: 16,
          height: 16,
          width: 16,
            },
    },
  });
